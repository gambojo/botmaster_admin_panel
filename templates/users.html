{% extends "base.html" %}

{% block title %}Users Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-users"></i> Users Management</h1>
        <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –±–æ—Ç–∞</p>
    </div>
</div>

<!-- Filters -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-filter"></i> –§–∏–ª—å—Ç—Ä—ã</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="searchInput" class="form-label">–ü–æ–∏—Å–∫</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="–ò–º—è –∏–ª–∏ username">
                    </div>
                    <div class="col-md-2">
                        <label for="roleFilter" class="form-label">–†–æ–ª—å</label>
                        <select class="form-select" id="roleFilter">
                            <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                            <option value="USER">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                            <option value="ADMIN">–ê–¥–º–∏–Ω</option>
                            <option value="SUPER_ADMIN">–°—É–ø–µ—Ä –ê–¥–º–∏–Ω</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="statusFilter" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">–í—Å–µ</option>
                            <option value="false">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                            <option value="true">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="loadUsers()">
                            <i class="fas fa-search"></i> –ù–∞–π—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
            </div>
            <div class="card-body">
                <div id="usersTable">
                    <p><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title" id="userModalTitle">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body" id="userModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- Send Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <form id="sendMessageForm" enctype="multipart/form-data">
                    <input type="hidden" id="messageUserId">

                    <!-- –¢–∏–ø –º–µ–¥–∏–∞ -->
                    <div class="mb-3">
                        <label class="form-label">–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
                        <select class="form-select" id="mediaType">
                            <option value="text">–¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç</option>
                            <option value="photo">–§–æ—Ç–æ —Å —Ç–µ–∫—Å—Ç–æ–º</option>
                            <option value="video">–í–∏–¥–µ–æ —Å —Ç–µ–∫—Å—Ç–æ–º</option>
                            <option value="document">–î–æ–∫—É–º–µ–Ω—Ç —Å —Ç–µ–∫—Å—Ç–æ–º</option>
                        </select>
                    </div>

                    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
                    <div class="mb-3" id="mediaUploadBlock" style="display: none;">
                        <label for="mediaFile" class="form-label">–§–∞–π–ª</label>
                        <input type="file" class="form-control" id="mediaFile" accept="image/*,video/*,*/*">
                        <div class="form-text">
                            –§–æ—Ç–æ: JPG, PNG –¥–æ 10MB | –í–∏–¥–µ–æ: MP4, MOV –¥–æ 50MB | –î–æ–∫—É–º–µ–Ω—Ç: –ª—é–±–æ–π —Ñ–æ—Ä–º–∞—Ç –¥–æ 50MB
                        </div>
                        <!-- –ü—Ä–µ–≤—å—é -->
                        <div id="mediaPreview" class="mt-2" style="display: none;">
                            <img id="imagePreview" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                            <video id="videoPreview" controls style="max-width: 100%; max-height: 200px; border-radius: 8px; display: none;"></video>
                        </div>
                    </div>

                    <!-- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
                    <div class="mb-3">
                        <label for="messageText" class="form-label">
                            –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (HTML)
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleHtmlHelp()">
                                <i class="fas fa-question-circle"></i> –°–ø—Ä–∞–≤–∫–∞
                            </button>
                        </label>
                        <textarea class="form-control font-monospace" id="messageText" rows="6"
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."></textarea>

                        <!-- HTML –ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
                        <div id="htmlHelp" class="alert alert-info mt-2" style="display: none; font-size: 0.85rem; max-height: 400px; overflow-y: auto;">
                            <strong>üìù –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞:</strong><br>
                            <code>&lt;b&gt;–∂–∏—Ä–Ω—ã–π&lt;/b&gt;</code> –∏–ª–∏ <code>&lt;strong&gt;–∂–∏—Ä–Ω—ã–π&lt;/strong&gt;</code> - <b>–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</b><br>
                            <code>&lt;i&gt;–∫—É—Ä—Å–∏–≤&lt;/i&gt;</code> –∏–ª–∏ <code>&lt;em&gt;–∫—É—Ä—Å–∏–≤&lt;/em&gt;</code> - <i>–∫—É—Ä—Å–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç</i><br>
                            <code>&lt;u&gt;–ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π&lt;/u&gt;</code> - <u>–ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç</u><br>
                            <code>&lt;s&gt;–∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π&lt;/s&gt;</code> –∏–ª–∏ <code>&lt;strike&gt;...&lt;/strike&gt;</code> –∏–ª–∏ <code>&lt;del&gt;...&lt;/del&gt;</code> - <s>–∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç</s><br>
                            <code>&lt;code&gt;–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π&lt;/code&gt;</code> - <code>–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π –∫–æ–¥</code><br>
                            <code>&lt;pre&gt;–±–ª–æ–∫ –∫–æ–¥–∞&lt;/pre&gt;</code> - –±–ª–æ–∫ –∫–æ–¥–∞ (–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π)<br>
                            <br>
                            <strong>üîó –°—Å—ã–ª–∫–∏ –∏ —ç–ª–µ–º–µ–Ω—Ç—ã:</strong><br>
                            <code>&lt;a href="https://example.com"&gt;—Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏&lt;/a&gt;</code> - –æ–±—ã—á–Ω–∞—è —Å—Å—ã–ª–∫–∞<br>
                            <code>&lt;a href="tg://user?id=USER_ID"&gt;–∏–º—è&lt;/a&gt;</code> - —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è<br>
                            <code>&lt;blockquote&gt;—Ü–∏—Ç–∞—Ç–∞&lt;/blockquote&gt;</code> - –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ü–∏—Ç–∞—Ç<br>
                            <code>&lt;li&gt;–ü—É–Ω–∫—Ç —Å–ø–∏—Å–∫–∞&lt;/li&gt;</code> - —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞<br>
                            <br>
                            <strong>‚ö†Ô∏è –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤:</strong><br>
                            <code>&amp;</code> ‚Üí <code>&amp;amp;</code><br>
                            <code>&lt;</code> ‚Üí <code>&amp;lt;</code><br>
                            <code>&gt;</code> ‚Üí <code>&amp;gt;</code><br>
                            <code>"</code> ‚Üí <code>&amp;quot;</code><br>
                            <br>
                            <small class="text-muted">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ —ç—Ç–∏ —Å–∏–º–≤–æ–ª—ã –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞–∫ —Ç–µ–∫—Å—Ç, –∞ –Ω–µ –∫–∞–∫ HTML —Ç–µ–≥–∏.</small>
                        </div>
                    </div>

                    <!-- –ü—Ä–µ–≤—å—é —Å–æ–æ–±—â–µ–Ω–∏—è -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="previewMessage()">
                            <i class="fas fa-eye"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                        <div id="messagePreview" class="mt-2 p-3 border rounded" style="display: none; background: #f8f9fa;">
                            <div id="previewContent"></div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- User Groups Management Modal -->
<div class="modal fade" id="userGroupsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title" id="userGroupsModalTitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body" id="userGroupsModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentUsers = [];
let userModal, messageModal, userGroupsModal;

document.addEventListener('DOMContentLoaded', function() {
    userModal = new bootstrap.Modal(document.getElementById('userModal'));
    messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
    userGroupsModal = new bootstrap.Modal(document.getElementById('userGroupsModal'));

    loadUsers();
});

async function loadUsers() {
    try {
        const search = document.getElementById('searchInput').value;
        const role = document.getElementById('roleFilter').value;
        const blocked = document.getElementById('statusFilter').value;

        let url = '/api/users?';
        if (search) url += `search=${encodeURIComponent(search)}&`;
        if (role) url += `role=${role}&`;
        if (blocked) url += `blocked=${blocked}&`;

        const data = await ApiClient.get(url);

        if (data.success) {
            currentUsers = data.users;
            renderUsersTable(data.users);
        } else {
            document.getElementById('usersTable').innerHTML =
                '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
        }
    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTable').innerHTML =
            '<div class="alert alert-danger">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
    }
}

function renderUsersTable(users) {
    if (users.length === 0) {
        document.getElementById('usersTable').innerHTML =
            '<div class="alert alert-info">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
    }

    const isMobile = window.innerWidth < 768;

    if (isMobile) {
        // Mobile version - compact cards with toggle actions
        const cardsHtml = `
            <div class="users-mobile-list">
                ${users.map(user => `
                    <div class="user-card-mobile">
                        <div class="user-card-header" onclick="viewUserDetails(${user.id})">
                            <div class="user-info">
                                <div class="user-name">${user.first_name} ${user.last_name || ''}</div>
                                <div class="user-username">@${user.username || 'N/A'}</div>
                            </div>
                            <div class="user-status">
                                ${user.is_blocked ?
                                    '<span class="badge bg-danger">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>' :
                                    '<span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>'}
                            </div>
                        </div>
                        <div class="user-card-footer">
                            <div class="user-footer-info">
                                <span class="user-id">ID: ${user.id}</span>
                                <span class="user-role badge bg-primary">${user.role}</span>
                            </div>
                            <button class="btn btn-sm btn-outline-primary toggle-actions-btn"
                                    onclick="toggleUserActions(event, ${user.id})"
                                    title="–î–µ–π—Å—Ç–≤–∏—è">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                        <div class="user-actions-menu" id="actions-${user.id}" style="display: none;">
                            <button class="btn btn-sm btn-outline-info w-100 mb-2" onclick="viewUserDetails(${user.id})">
                                <i class="fas fa-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </button>
                            <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="showMessageModal(${user.id}, '${user.first_name}')">
                                <i class="fas fa-envelope"></i> –°–æ–æ–±—â–µ–Ω–∏–µ
                            </button>
                            ${!user.is_blocked ?
                                `<button class="btn btn-sm btn-outline-warning w-100 mb-2" onclick="blockUser(${user.id})">
                                    <i class="fas fa-ban"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                </button>` :
                                `<button class="btn btn-sm btn-outline-success w-100 mb-2" onclick="unblockUser(${user.id})">
                                    <i class="fas fa-check"></i> –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                </button>`
                            }
                            <button class="btn btn-sm btn-outline-danger w-100" onclick="deleteUser(${user.id})">
                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        document.getElementById('usersTable').innerHTML = cardsHtml;
    } else {
        // Desktop version - table with actions
        const tableHtml = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>–ò–º—è</th>
                            <th>–†–æ–ª—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.id}</td>
                                <td>@${user.username || 'N/A'}</td>
                                <td>${user.first_name} ${user.last_name || ''}</td>
                                <td><span class="badge bg-primary">${user.role}</span></td>
                                <td>${user.is_blocked ?
                                    '<span class="badge bg-danger">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>' :
                                    '<span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>'}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-info" onclick="viewUserDetails(${user.id})" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="showMessageModal(${user.id}, '${user.first_name}')" title="–°–æ–æ–±—â–µ–Ω–∏–µ">
                                            <i class="fas fa-envelope"></i>
                                        </button>
                                        ${!user.is_blocked ?
                                            `<button class="btn btn-outline-warning" onclick="blockUser(${user.id})" title="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å">
                                                <i class="fas fa-ban"></i>
                                            </button>` :
                                            `<button class="btn btn-outline-success" onclick="unblockUser(${user.id})" title="–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å">
                                                <i class="fas fa-check"></i>
                                            </button>`
                                        }
                                        <button class="btn btn-outline-danger" onclick="deleteUser(${user.id})" title="–£–¥–∞–ª–∏—Ç—å">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        document.getElementById('usersTable').innerHTML = tableHtml;
    }
}

async function viewUserDetails(userId, skipShowModal = false) {
    try {
        const data = await ApiClient.get(`/api/users/${userId}`);

        if (data.success) {
            const user = data.user;
            currentUserIdInModal = userId; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

            const created = user.created_at ? new Date(user.created_at).toLocaleString('ru-RU') : 'N/A';
            const lastActivity = user.last_activity ? new Date(user.last_activity).toLocaleString('ru-RU') : 'N/A';

            const groupsList = user.groups && user.groups.length > 0
                ? user.groups.map(g => `<span class="badge bg-info me-1">${g}</span>`).join('')
                : '<span class="text-muted">–ù–µ—Ç –≥—Ä—É–ø–ø</span>';

            document.getElementById('userModalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <table class="table table-sm">
                            <tr><td><strong>ID:</strong></td><td>${user.id}</td></tr>
                            <tr><td><strong>Username:</strong></td><td>@${user.username || 'N/A'}</td></tr>
                            <tr><td><strong>–ò–º—è:</strong></td><td>${user.first_name} ${user.last_name || ''}</td></tr>
                            <tr><td><strong>–†–æ–ª—å:</strong></td><td><span class="badge bg-primary">${user.role}</span></td></tr>
                            <tr><td><strong>–°—Ç–∞—Ç—É—Å:</strong></td><td>
                                ${user.is_blocked ?
                                    '<span class="badge bg-danger">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>' :
                                    '<span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>'}
                            </td></tr>
                        </table>

                        <h6 class="mt-3">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>–ì—Ä—É–ø–ø—ã:</strong></td>
                                <td>${groupsList}</td>
                            </tr>
                            <tr><td><strong>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</strong></td><td>${created}</td></tr>
                            <tr><td><strong>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong></td><td>${lastActivity}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>–î–µ–π—Å—Ç–≤–∏—è</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-primary" onclick="showMessageModal(${user.id}, '${user.first_name}')">
                                <i class="fas fa-envelope"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                            </button>
                            ${!user.is_blocked ?
                                `<button class="btn btn-sm btn-warning" onclick="blockUser(${user.id})">
                                    <i class="fas fa-ban"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                </button>` :
                                `<button class="btn btn-sm btn-success" onclick="unblockUser(${user.id})">
                                    <i class="fas fa-check"></i> –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                </button>`
                            }
                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            </button>
                        </div>

                        <h6 class="mt-3">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—å—é</h6>
                        <div class="d-grid gap-2">
                            ${user.role.toUpperCase() !== 'SUPER_ADMIN' ? `
                                <button class="btn btn-sm btn-outline-${user.role.toUpperCase() === 'ADMIN' ? 'secondary' : 'warning'}"
                                        onclick="changeUserRole(${user.id}, '${user.role.toUpperCase() === 'ADMIN' ? 'USER' : 'ADMIN'}')">
                                    <i class="fas fa-${user.role.toUpperCase() === 'ADMIN' ? 'user' : 'user-shield'}"></i>
                                    ${user.role.toUpperCase() === 'ADMIN' ? '–°–¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º' : '–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º'}
                                </button>
                            ` : '<span class="text-muted">–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω (—Ä–æ–ª—å –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å)</span>'}
                        </div>

                        <h6 class="mt-3">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-outline-info" onclick="showUserGroupsModal(${user.id})">
                                <i class="fas fa-users"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏
                            </button>
                        </div>
                    </div>
                </div>
            `;

            if (!skipShowModal) {
                userModal.show();
            }
        }
    } catch (error) {
        console.error('Error loading user details:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    }
}

function showMessageModal(userId, userName) {
    document.getElementById('messageUserId').value = userId;
    document.getElementById('messageText').value = '';
    document.getElementById('mediaType').value = 'text';
    document.getElementById('mediaFile').value = '';
    document.getElementById('mediaUploadBlock').style.display = 'none';
    document.getElementById('mediaPreview').style.display = 'none';
    document.getElementById('messagePreview').style.display = 'none';
    document.getElementById('htmlHelp').style.display = 'none';
    document.querySelector('#messageModal .modal-title').textContent = `–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userName}`;
    messageModal.show();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –º–µ–¥–∏–∞
document.addEventListener('DOMContentLoaded', function() {
    const mediaTypeSelect = document.getElementById('mediaType');
    const mediaFileInput = document.getElementById('mediaFile');
    const sendMessageForm = document.getElementById('sendMessageForm');

    if (mediaTypeSelect) {
        mediaTypeSelect.addEventListener('change', function() {
            const uploadBlock = document.getElementById('mediaUploadBlock');
            const fileInput = document.getElementById('mediaFile');

            if (this.value === 'text') {
                uploadBlock.style.display = 'none';
                fileInput.value = '';
                document.getElementById('mediaPreview').style.display = 'none';
            } else {
                uploadBlock.style.display = 'block';

                // –û–±–Ω–æ–≤–ª—è–µ–º accept –∞—Ç—Ä–∏–±—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                if (this.value === 'photo') {
                    fileInput.accept = 'image/*';
                } else if (this.value === 'video') {
                    fileInput.accept = 'video/*';
                } else if (this.value === 'document') {
                    fileInput.accept = '*/*';
                }
            }
        });
    }

    if (mediaFileInput) {
        mediaFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const previewContainer = document.getElementById('mediaPreview');
            const imagePreview = document.getElementById('imagePreview');
            const videoPreview = document.getElementById('videoPreview');

            // –°–∫—Ä—ã–≤–∞–µ–º –æ–±–∞ –ø—Ä–µ–≤—å—é
            imagePreview.style.display = 'none';
            videoPreview.style.display = 'none';

            const mediaType = document.getElementById('mediaType').value;

            if (mediaType === 'photo' && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else if (mediaType === 'video' && file.type.startsWith('video/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    videoPreview.src = e.target.result;
                    videoPreview.style.display = 'block';
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.style.display = 'none';
            }
        });
    }

    if (sendMessageForm) {
        sendMessageForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await sendMessage();
        });
    }
});

function toggleHtmlHelp() {
    const helpDiv = document.getElementById('htmlHelp');
    helpDiv.style.display = helpDiv.style.display === 'none' ? 'block' : 'none';
}

function previewMessage() {
    const messageText = document.getElementById('messageText').value;
    const previewDiv = document.getElementById('messagePreview');
    const previewContent = document.getElementById('previewContent');

    if (!messageText.trim()) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
        return;
    }

    // –ü—Ä–æ—Å—Ç–æ–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ HTML
    previewContent.innerHTML = messageText;
    previewDiv.style.display = 'block';
}

async function sendMessage() {
    const userId = document.getElementById('messageUserId').value;
    const messageText = document.getElementById('messageText').value;
    const mediaType = document.getElementById('mediaType').value;
    const mediaFile = document.getElementById('mediaFile').files[0];

    if (!messageText.trim() && mediaType === 'text') {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
    }

    if (mediaType !== 'text' && !mediaFile) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
        return;
    }

    try {
        let response;

        if (mediaType === 'text') {
            // –î–ª—è —Ç–µ–∫—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º JSON
            response = await fetch(`/api/users/${userId}/message`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: messageText,
                    media_type: 'text'
                }),
                credentials: 'include'
            });
        } else {
            // –î–ª—è –º–µ–¥–∏–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º FormData
            const formData = new FormData();
            formData.append('message', messageText);
            formData.append('media_type', mediaType);
            formData.append('media', mediaFile);

            response = await fetch(`/api/users/${userId}/message`, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
        }

        const data = await response.json();

        if (data.success) {
            alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
            messageModal.hide();
            document.getElementById('messageText').value = '';
            document.getElementById('mediaFile').value = '';
            document.getElementById('mediaType').value = 'text';
            document.getElementById('mediaUploadBlock').style.display = 'none';
            document.getElementById('messagePreview').style.display = 'none';
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ'));
        }
    } catch (error) {
        console.error('Error sending message:', error);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
    }
}

async function blockUser(userId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
        return;
    }

    try {
        const data = await ApiClient.post(`/api/users/${userId}/block`);

        if (data.success) {
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
            userModal.hide();
            loadUsers();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'));
        }
    } catch (error) {
        console.error('Error blocking user:', error);
        alert('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏');
    }
}

async function unblockUser(userId) {
    try {
        const data = await ApiClient.post(`/api/users/${userId}/unblock`);

        if (data.success) {
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
            userModal.hide();
            loadUsers();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'));
        }
    } catch (error) {
        console.error('Error unblocking user:', error);
        alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏');
    }
}

async function deleteUser(userId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –£–î–ê–õ–ò–¢–¨ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) {
        return;
    }

    try {
        const data = await ApiClient.delete(`/api/users/${userId}`);

        if (data.success) {
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
            userModal.hide();
            loadUsers();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å'));
        }
    } catch (error) {
        console.error('Error deleting user:', error);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    }
}

function toggleUserActions(event, userId) {
    if (event) {
        event.stopPropagation(); // Prevent card click event
        event.preventDefault(); // Prevent default button behavior
    }

    const actionsMenu = document.getElementById(`actions-${userId}`);
    const allMenus = document.querySelectorAll('.user-actions-menu');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–Ω—é –î–û –µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    const isCurrentlyVisible = actionsMenu.style.display === 'block';

    // Close all menus first
    allMenus.forEach(menu => {
        menu.style.display = 'none';
    });

    // Toggle current menu (–µ—Å–ª–∏ –±—ã–ª–æ —Å–∫—Ä—ã—Ç–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –ø–æ–∫–∞–∑–∞–Ω–æ - –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–º)
    if (!isCurrentlyVisible) {
        actionsMenu.style.display = 'block';
    }
}

async function showUserGroupsModal(userId) {
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø–∞—Ö
        const [userData, groupsData] = await Promise.all([
            ApiClient.get(`/api/users/${userId}`),
            ApiClient.get('/api/groups')
        ]);

        if (!userData.success || !groupsData.success) {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            return;
        }

        const user = userData.user;
        const allGroups = groupsData.groups;
        const userGroups = user.groups || [];

        document.getElementById('userGroupsModalTitle').textContent =
            `–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏: ${user.first_name}`;

        let html = `
            <div class="row">
                <div class="col-md-6">
                    <h6>–ì—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h6>
                    <div id="currentGroupsList">
                        ${userGroups.length > 0 ? `
                            <div class="list-group">
                                ${userGroups.map(groupName => `
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-users text-info"></i> ${groupName}</span>
                                        <button class="btn btn-sm btn-outline-danger"
                                                onclick="removeUserFromGroupInModal(${userId}, '${groupName}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –Ω–∏ –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ</p>'}
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>–î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É</h6>
                    <div class="list-group">
                        ${allGroups.filter(g => !userGroups.includes(g.name)).map(group => `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-users text-secondary"></i> ${group.name}</span>
                                <button class="btn btn-sm btn-outline-success"
                                        onclick="addUserToGroupInModal(${userId}, '${group.name}')">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        `).join('') || '<p class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø</p>'}
                    </div>
                </div>
            </div>
        `;

        document.getElementById('userGroupsModalBody').innerHTML = html;
        userGroupsModal.show();

    } catch (error) {
        console.error('Error loading user groups:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø');
    }
}

async function addUserToGroupInModal(userId, groupName) {
    try {
        const data = await ApiClient.post(`/api/groups/${groupName}/users`, {
            user_id: userId
        });

        if (data.success) {
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É');
            await showUserGroupsModal(userId); // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
            await refreshUserDetailsIfOpen(userId);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å'));
        }
    } catch (error) {
        console.error('Error adding user to group:', error);
        alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É');
    }
}

async function removeUserFromGroupInModal(userId, groupName) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –≥—Ä—É–ø–ø—ã "${groupName}"?`)) {
        return;
    }

    try {
        const data = await ApiClient.delete(`/api/groups/${groupName}/users/${userId}`);

        if (data.success) {
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω –∏–∑ –≥—Ä—É–ø–ø—ã');
            await showUserGroupsModal(userId); // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
            await refreshUserDetailsIfOpen(userId);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å'));
        }
    } catch (error) {
        console.error('Error removing user from group:', error);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –≥—Ä—É–ø–ø—ã');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ, –µ—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
let currentUserIdInModal = null;

async function refreshUserDetailsIfOpen(userId) {
    if (currentUserIdInModal === userId) {
        // –ï—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –æ—Ç–∫—Ä—ã—Ç–æ, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
        await viewUserDetails(userId, true); // true = –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ, —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–∏—Ç—å
    }
}

async function changeUserRole(userId, newRole) {
    const roleText = newRole === 'ADMIN' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º' : '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${roleText}?`)) {
        return;
    }

    try {
        console.log('Sending PUT request to:', `/api/users/${userId}/role`);
        console.log('With data:', { role: newRole });

        const data = await ApiClient.put(`/api/users/${userId}/role`, {
            role: newRole
        });

        console.log('Received response:', data);

        if (data.success) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ —Ä–æ–ª—å —É–∂–µ —Ç–∞–∫–æ–π –∂–µ
            if (data.message && data.message.includes('already has role')) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∏–º–µ–µ—Ç —ç—Ç—É —Ä–æ–ª—å');
            } else {
                alert(`–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ${roleText}`);
            }
            await viewUserDetails(userId, true); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            loadUsers(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        } else {
            // –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
            let errorMsg = '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å';
            if (data.error) {
                if (data.error.includes('SUPER_ADMIN')) {
                    errorMsg = '–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞';
                } else if (data.error.includes('Cannot assign SUPER_ADMIN')) {
                    errorMsg = '–ù–µ–ª—å–∑—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å';
                } else if (data.error.includes('User not found')) {
                    errorMsg = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
                } else if (data.error.includes('Unauthorized')) {
                    errorMsg = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å.';
                } else {
                    errorMsg = data.error;
                }
            }
            alert('–û—à–∏–±–∫–∞: ' + errorMsg);
        }
    } catch (error) {
        console.error('Error changing user role:', error);
        console.error('Error details:', {
            message: error.message,
            stack: error.stack
        });
        alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + error.message + '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
    }
}

// Resize handler
window.addEventListener('resize', function() {
    if (currentUsers.length > 0) {
        renderUsersTable(currentUsers);
    }
});
</script>

<style>
/* Mobile user cards */
.users-mobile-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.user-card-mobile {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.15s;
}

.user-card-mobile:hover {
    background: var(--bg-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.user-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.user-info {
    flex: 1;
}

.user-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.user-username {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.user-status {
    margin-left: 0.5rem;
}

.user-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
    font-size: 0.8rem;
}

.user-footer-info {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.user-id {
    color: var(--text-muted);
}

.user-role {
    font-size: 0.75rem;
}

.toggle-actions-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
}

.user-actions-menu {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border-color);
    animation: slideDown 0.2s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Modal styling */
.modal-content .table {
    color: var(--text-primary);
}

.modal-content .table td {
    border-color: var(--border-color);
}
</style>
{% endblock %}
