{% extends "base.html" %}

{% block title %}Broadcast{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-bullhorn"></i> Broadcast Messages</h1>
        <p class="text-muted">–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</p>
    </div>
</div>

<!-- New Broadcast Form -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-plus"></i> –ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h5>
            </div>
            <div class="card-body">
                <form id="broadcastForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="targetType" class="form-label">–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</label>
                                <select class="form-select" id="targetType" required>
                                    <option value="group">–ü–æ –≥—Ä—É–ø–ø–µ</option>
                                    <option value="admins">–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
                                    <option value="specific">–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- –°–µ–ª–µ–∫—Ç–æ—Ä –≥—Ä—É–ø–ø—ã -->
                            <div class="mb-3" id="groupSelectorContainer">
                                <label for="groupSelector" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</label>
                                <select class="form-select" id="groupSelector">
                                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                                </select>
                            </div>

                            <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                            <div class="mb-3" id="userSearchContainer" style="display: none;">
                                <label for="broadcastUserSearch" class="form-label">–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                                <input type="text" class="form-control" id="broadcastUserSearch"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è, username –∏–ª–∏ ID">
                                <input type="hidden" id="selectedBroadcastUserId">

                                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
                                <div id="broadcastUserSearchResults" class="mt-2" style="display: none;">
                                    <div id="broadcastUserSearchList" class="list-group" style="max-height: 200px; overflow-y: auto;">
                                        <!-- Dynamic search results -->
                                    </div>
                                </div>

                                <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
                                <div id="selectedBroadcastUserInfo" class="alert alert-info mt-2" style="display: none;">
                                    <i class="fas fa-user"></i> <span id="selectedBroadcastUserDisplay"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –¢–∏–ø –º–µ–¥–∏–∞ -->
                    <div class="mb-3">
                        <label class="form-label">–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
                        <select class="form-select" id="broadcastMediaType">
                            <option value="text">–¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç</option>
                            <option value="photo">–§–æ—Ç–æ —Å —Ç–µ–∫—Å—Ç–æ–º</option>
                            <option value="video">–í–∏–¥–µ–æ —Å —Ç–µ–∫—Å—Ç–æ–º</option>
                            <option value="document">–î–æ–∫—É–º–µ–Ω—Ç —Å —Ç–µ–∫—Å—Ç–æ–º</option>
                        </select>
                    </div>

                    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
                    <div class="mb-3" id="broadcastMediaUploadBlock" style="display: none;">
                        <label for="broadcastMediaFile" class="form-label">–§–∞–π–ª</label>
                        <input type="file" class="form-control" id="broadcastMediaFile" accept="image/*,video/*,*/*">
                        <div class="form-text">
                            –§–æ—Ç–æ: JPG, PNG –¥–æ 10MB | –í–∏–¥–µ–æ: MP4, MOV –¥–æ 50MB | –î–æ–∫—É–º–µ–Ω—Ç: –ª—é–±–æ–π —Ñ–æ—Ä–º–∞—Ç –¥–æ 50MB
                        </div>
                        <!-- –ü—Ä–µ–≤—å—é -->
                        <div id="broadcastMediaPreview" class="mt-2" style="display: none;">
                            <img id="broadcastImagePreview" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                            <video id="broadcastVideoPreview" controls style="max-width: 100%; max-height: 200px; border-radius: 8px; display: none;"></video>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="broadcastMessage" class="form-label">
                            –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (HTML)
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleBroadcastHtmlHelp()">
                                <i class="fas fa-question-circle"></i> –°–ø—Ä–∞–≤–∫–∞
                            </button>
                        </label>
                        <textarea class="form-control font-monospace" id="broadcastMessage" rows="8"
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏..."></textarea>

                        <!-- HTML –ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
                        <div id="broadcastHtmlHelp" class="alert alert-info mt-2" style="display: none; font-size: 0.85rem; max-height: 400px; overflow-y: auto;">
                            <strong>üìù –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞:</strong><br>
                            <code>&lt;b&gt;–∂–∏—Ä–Ω—ã–π&lt;/b&gt;</code> –∏–ª–∏ <code>&lt;strong&gt;–∂–∏—Ä–Ω—ã–π&lt;/strong&gt;</code> - <b>–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</b><br>
                            <code>&lt;i&gt;–∫—É—Ä—Å–∏–≤&lt;/i&gt;</code> –∏–ª–∏ <code>&lt;em&gt;–∫—É—Ä—Å–∏–≤&lt;/em&gt;</code> - <i>–∫—É—Ä—Å–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç</i><br>
                            <code>&lt;u&gt;–ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π&lt;/u&gt;</code> - <u>–ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç</u><br>
                            <code>&lt;s&gt;–∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π&lt;/s&gt;</code> –∏–ª–∏ <code>&lt;strike&gt;...&lt;/strike&gt;</code> –∏–ª–∏ <code>&lt;del&gt;...&lt;/del&gt;</code> - <s>–∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç</s><br>
                            <code>&lt;code&gt;–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π&lt;/code&gt;</code> - <code>–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π –∫–æ–¥</code><br>
                            <code>&lt;pre&gt;–±–ª–æ–∫ –∫–æ–¥–∞&lt;/pre&gt;</code> - –±–ª–æ–∫ –∫–æ–¥–∞ (–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π)<br>
                            <br>
                            <strong>üîó –°—Å—ã–ª–∫–∏ –∏ —ç–ª–µ–º–µ–Ω—Ç—ã:</strong><br>
                            <code>&lt;a href="https://example.com"&gt;—Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏&lt;/a&gt;</code> - –æ–±—ã—á–Ω–∞—è —Å—Å—ã–ª–∫–∞<br>
                            <code>&lt;a href="tg://user?id=USER_ID"&gt;–∏–º—è&lt;/a&gt;</code> - —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è<br>
                            <code>&lt;blockquote&gt;—Ü–∏—Ç–∞—Ç–∞&lt;/blockquote&gt;</code> - –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ü–∏—Ç–∞—Ç<br>
                            <code>&lt;li&gt;–ü—É–Ω–∫—Ç —Å–ø–∏—Å–∫–∞&lt;/li&gt;</code> - —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞<br>
                            <br>
                            <strong>‚ö†Ô∏è –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤:</strong><br>
                            <code>&amp;</code> ‚Üí <code>&amp;amp;</code><br>
                            <code>&lt;</code> ‚Üí <code>&amp;lt;</code><br>
                            <code>&gt;</code> ‚Üí <code>&amp;gt;</code><br>
                            <code>"</code> ‚Üí <code>&amp;quot;</code><br>
                            <br>
                            <small class="text-muted">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ —ç—Ç–∏ —Å–∏–º–≤–æ–ª—ã –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞–∫ —Ç–µ–∫—Å—Ç, –∞ –Ω–µ –∫–∞–∫ HTML —Ç–µ–≥–∏.</small>
                        </div>
                    </div>

                    <!-- –ü—Ä–µ–≤—å—é —Å–æ–æ–±—â–µ–Ω–∏—è -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="previewBroadcast()">
                            <i class="fas fa-eye"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                        <div id="broadcastMessagePreview" class="mt-2 p-3 border rounded" style="display: none; background: #f8f9fa;">
                            <div id="broadcastPreviewContent"></div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –†–∞—Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤—Å–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
                        –ü—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
                    </div>

                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i> –ù–∞—á–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Previous Broadcasts -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫</h5>
            </div>
            <div class="card-body">
                <div id="broadcastsList">
                    <p><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—ã–ª–æ–∫...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
<div class="modal fade" id="broadcastStatusModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title">–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—Å—ã–ª–∫–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body text-center">
                <div id="broadcastStatusIcon" class="mb-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                </div>
                <h4 id="broadcastStatusTitle">–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h4>
                <div class="mt-3">
                    <div class="row">
                        <div class="col-6">
                            <div class="p-3" style="background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #28a745;">
                                    <span id="broadcastSuccessCount">0</span>
                                </div>
                                <div class="text-muted">–£—Å–ø–µ—à–Ω–æ</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3" style="background: rgba(220, 53, 69, 0.1); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #dc3545;">
                                    <span id="broadcastFailCount">0</span>
                                </div>
                                <div class="text-muted">–û—à–∏–±–æ–∫</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
let broadcastStatusModal;

document.addEventListener('DOMContentLoaded', function() {
    broadcastStatusModal = new bootstrap.Modal(document.getElementById('broadcastStatusModal'));
    loadBroadcasts();
    loadGroupsForSelector();
    setupFormHandlers();
});

function setupFormHandlers() {
    // Show/hide containers based on target type selection
    document.getElementById('targetType').addEventListener('change', function() {
        const groupContainer = document.getElementById('groupSelectorContainer');
        const userSearchContainer = document.getElementById('userSearchContainer');

        if (this.value === 'group') {
            groupContainer.style.display = 'block';
            userSearchContainer.style.display = 'none';
        } else if (this.value === 'specific') {
            groupContainer.style.display = 'none';
            userSearchContainer.style.display = 'block';
        } else {
            // admins
            groupContainer.style.display = 'none';
            userSearchContainer.style.display = 'none';
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –º–µ–¥–∏–∞
    document.getElementById('broadcastMediaType').addEventListener('change', function() {
        const uploadBlock = document.getElementById('broadcastMediaUploadBlock');
        const fileInput = document.getElementById('broadcastMediaFile');

        if (this.value === 'text') {
            uploadBlock.style.display = 'none';
            fileInput.value = '';
            document.getElementById('broadcastMediaPreview').style.display = 'none';
        } else {
            uploadBlock.style.display = 'block';

            // –û–±–Ω–æ–≤–ª—è–µ–º accept –∞—Ç—Ä–∏–±—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            if (this.value === 'photo') {
                fileInput.accept = 'image/*';
            } else if (this.value === 'video') {
                fileInput.accept = 'video/*';
            } else if (this.value === 'document') {
                fileInput.accept = '*/*';
            }
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ —Å –ø—Ä–µ–≤—å—é
    document.getElementById('broadcastMediaFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const previewContainer = document.getElementById('broadcastMediaPreview');
        const imagePreview = document.getElementById('broadcastImagePreview');
        const videoPreview = document.getElementById('broadcastVideoPreview');

        // –°–∫—Ä—ã–≤–∞–µ–º –æ–±–∞ –ø—Ä–µ–≤—å—é
        imagePreview.style.display = 'none';
        videoPreview.style.display = 'none';

        const mediaType = document.getElementById('broadcastMediaType').value;

        if (mediaType === 'photo' && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else if (mediaType === 'video' && file.type.startsWith('video/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                videoPreview.src = e.target.result;
                videoPreview.style.display = 'block';
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            previewContainer.style.display = 'none';
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let searchTimeout;
    document.getElementById('broadcastUserSearch').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();

        if (query.length < 2) {
            document.getElementById('broadcastUserSearchResults').style.display = 'none';
            return;
        }

        searchTimeout = setTimeout(async () => {
            await searchBroadcastUsers(query);
        }, 300);
    });

    // Form submission
    document.getElementById('broadcastForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await sendBroadcast();
    });
}

async function loadGroupsForSelector() {
    try {
        const data = await ApiClient.get('/api/groups');

        if (data.success) {
            const selector = document.getElementById('groupSelector');
            selector.innerHTML = data.groups.map(group =>
                `<option value="${group.name}">${group.name} (${group.members_count || 0} —á–µ–ª.)</option>`
            ).join('');
        }
    } catch (error) {
        console.error('Error loading groups:', error);
    }
}

async function searchBroadcastUsers(query) {
    try {
        const data = await ApiClient.get(`/api/users?search=${encodeURIComponent(query)}`);

        if (data.success) {
            renderBroadcastUserSearchResults(data.users);
        }
    } catch (error) {
        console.error('Error searching users:', error);
    }
}

function renderBroadcastUserSearchResults(users) {
    const container = document.getElementById('broadcastUserSearchList');
    const resultsDiv = document.getElementById('broadcastUserSearchResults');

    if (!users || users.length === 0) {
        resultsDiv.style.display = 'none';
        return;
    }

    container.innerHTML = users.map(user => `
        <a href="#" class="list-group-item list-group-item-action"
           onclick="selectBroadcastUser(${user.telegram_id}, '${user.first_name || ''}', '${user.last_name || ''}', '${user.username || ''}'); return false;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${user.first_name || ''} ${user.last_name || ''}</strong>
                    ${user.username ? `<span class="text-muted">@${user.username}</span>` : ''}
                    <br>
                    <small class="text-muted">ID: ${user.telegram_id}</small>
                </div>
            </div>
        </a>
    `).join('');

    resultsDiv.style.display = 'block';
}

function selectBroadcastUser(userId, firstName, lastName, username) {
    document.getElementById('selectedBroadcastUserId').value = userId;
    document.getElementById('selectedBroadcastUserDisplay').textContent =
        `${firstName} ${lastName} ${username ? '@' + username : ''} [ID: ${userId}]`;
    document.getElementById('selectedBroadcastUserInfo').style.display = 'block';
    document.getElementById('broadcastUserSearchResults').style.display = 'none';
    document.getElementById('broadcastUserSearch').value = '';
}

function toggleBroadcastHtmlHelp() {
    const helpDiv = document.getElementById('broadcastHtmlHelp');
    helpDiv.style.display = helpDiv.style.display === 'none' ? 'block' : 'none';
}

function previewBroadcast() {
    const messageText = document.getElementById('broadcastMessage').value;
    const previewDiv = document.getElementById('broadcastMessagePreview');
    const previewContent = document.getElementById('broadcastPreviewContent');

    if (!messageText.trim()) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
        return;
    }

    // –ü—Ä–æ—Å—Ç–æ–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ HTML
    previewContent.innerHTML = messageText;
    previewDiv.style.display = 'block';
}

async function sendBroadcast() {
    const messageText = document.getElementById('broadcastMessage').value;
    const mediaType = document.getElementById('broadcastMediaType').value;
    const mediaFile = document.getElementById('broadcastMediaFile').files[0];
    const targetType = document.getElementById('targetType').value;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º target_value –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    let targetValue = null;
    if (targetType === 'group') {
        targetValue = document.getElementById('groupSelector').value;
        if (!targetValue) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É', 'warning');
            return;
        }
    } else if (targetType === 'specific') {
        targetValue = document.getElementById('selectedBroadcastUserId').value;
        if (!targetValue) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'warning');
            return;
        }
    }

    // Validation
    if (!messageText.trim() && mediaType === 'text') {
        showNotification('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è', 'warning');
        return;
    }

    if (mediaType !== 'text' && !mediaFile) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏', 'warning');
        return;
    }

    if (messageText.length > 4096) {
        showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å. 4096 —Å–∏–º–≤–æ–ª–æ–≤)', 'warning');
        return;
    }

    try {
        const submitBtn = document.querySelector('#broadcastForm button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';

        let response;

        if (mediaType === 'text') {
            // –î–ª—è —Ç–µ–∫—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º JSON
            const jsonData = {
                message: messageText,
                media_type: 'text',
                target_type: targetType
            };

            if (targetValue) {
                jsonData.target_value = targetValue;
            }

            response = await fetch('/api/broadcast', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(jsonData),
                credentials: 'include'
            });
        } else {
            // –î–ª—è –º–µ–¥–∏–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º FormData
            const formData = new FormData();
            formData.append('message', messageText);
            formData.append('media_type', mediaType);
            formData.append('media', mediaFile);
            formData.append('target_type', targetType);

            if (targetValue) {
                formData.append('target_value', targetValue);
            }

            response = await fetch('/api/broadcast', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
        }

        const data = await response.json();

        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º
            document.getElementById('broadcastSuccessCount').textContent = data.success_count;
            document.getElementById('broadcastFailCount').textContent = data.fail_count;
            broadcastStatusModal.show();

            // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
            document.getElementById('broadcastForm').reset();

            // –°–±—Ä–æ—Å —Ç–∏–ø–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –Ω–∞ "–≥—Ä—É–ø–ø—ã"
            document.getElementById('targetType').value = 'group';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –≥—Ä—É–ø–ø, —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('groupSelectorContainer').style.display = 'block';
            document.getElementById('userSearchContainer').style.display = 'none';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–ø–ø—ã –∏ –≤—ã–±–∏—Ä–∞–µ–º default
            await loadGroupsForSelector();
            document.getElementById('groupSelector').value = 'default';

            // –°–±—Ä–æ—Å —Ç–∏–ø–∞ –º–µ–¥–∏–∞ –Ω–∞ "—Ç–µ–∫—Å—Ç"
            document.getElementById('broadcastMediaType').value = 'text';

            // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫–∏ –º–µ–¥–∏–∞ –∏ –ø—Ä–µ–≤—å—é
            document.getElementById('broadcastMediaUploadBlock').style.display = 'none';
            document.getElementById('broadcastMediaPreview').style.display = 'none';
            document.getElementById('broadcastMessagePreview').style.display = 'none';
            document.getElementById('broadcastHtmlHelp').style.display = 'none';

            // –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª
            document.getElementById('broadcastMediaFile').value = '';

            // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            document.getElementById('broadcastMessage').value = '';

            // –°–±—Ä–æ—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('selectedBroadcastUserInfo').style.display = 'none';
            document.getElementById('selectedBroadcastUserId').value = '';
            document.getElementById('broadcastUserSearch').value = '';

            loadBroadcasts(); // Reload broadcasts list
        } else {
            showNotification(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ä–∞—Å—Å—ã–ª–∫–∏', 'error');
        }
    } catch (error) {
        console.error('Error sending broadcast:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
    } finally {
        const submitBtn = document.querySelector('#broadcastForm button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> –ù–∞—á–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É';
    }
}

async function loadBroadcasts() {
    try {
        const data = await ApiClient.get('/api/broadcast');

        if (data.success) {
            renderBroadcasts(data.broadcasts);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—ã–ª–æ–∫', 'error');
        }
    } catch (error) {
        console.error('Error loading broadcasts:', error);
        document.getElementById('broadcastsList').innerHTML = `
            <div class="alert alert-danger">
                –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—Å—ã–ª–æ–∫
            </div>
        `;
    }
}

function renderBroadcasts(broadcasts) {
    const container = document.getElementById('broadcastsList');

    if (!broadcasts || broadcasts.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-bullhorn fa-3x mb-3"></i>
                <p>–†–∞—Å—Å—ã–ª–æ–∫ –µ—â–µ –Ω–µ –±—ã–ª–æ</p>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–¢–∏–ø</th>
                        <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                        <th>–ê—É–¥–∏—Ç–æ—Ä–∏—è</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                    </tr>
                </thead>
                <tbody>
                    ${broadcasts.map(broadcast => `
                        <tr>
                            <td>#${broadcast.id}</td>
                            <td>
                                <span class="badge ${getMediaTypeBadge(broadcast.media_type)}">
                                    ${getMediaTypeIcon(broadcast.media_type)} ${getMediaTypeText(broadcast.media_type)}
                                </span>
                            </td>
                            <td class="text-truncate" style="max-width: 300px;" title="${escapeHtml(broadcast.message)}">
                                ${broadcast.message ? escapeHtml(broadcast.message.substring(0, 60)) + (broadcast.message.length > 60 ? '...' : '') : '<i>–±–µ–∑ —Ç–µ–∫—Å—Ç–∞</i>'}
                            </td>
                            <td>
                                ${getTargetTypeText(broadcast.target_type)}
                                ${broadcast.target_value ? `<br><small class="text-muted">${broadcast.target_value}</small>` : ''}
                            </td>
                            <td><small>${formatTimestamp(broadcast.sent_at)}</small></td>
                            <td>
                                <span class="badge bg-success">${broadcast.success_count || 0}</span>
                                <span class="badge bg-danger">${broadcast.fail_count || 0}</span>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function getTargetTypeText(type) {
    const types = {
        'admins': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã',
        'group': '–ì—Ä—É–ø–ø–∞',
        'specific': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
    };
    return types[type] || type;
}

function getMediaTypeText(type) {
    const types = {
        'text': '–¢–µ–∫—Å—Ç',
        'photo': '–§–æ—Ç–æ',
        'video': '–í–∏–¥–µ–æ',
        'document': '–î–æ–∫—É–º–µ–Ω—Ç'
    };
    return types[type] || type;
}

function getMediaTypeIcon(type) {
    const icons = {
        'text': '<i class="fas fa-file-alt"></i>',
        'photo': '<i class="fas fa-image"></i>',
        'video': '<i class="fas fa-video"></i>',
        'document': '<i class="fas fa-file"></i>'
    };
    return icons[type] || '<i class="fas fa-question"></i>';
}

function getMediaTypeBadge(type) {
    const badges = {
        'text': 'bg-secondary',
        'photo': 'bg-primary',
        'video': 'bg-info',
        'document': 'bg-warning'
    };
    return badges[type] || 'bg-secondary';
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function formatTimestamp(timestamp) {
    if (!timestamp) return 'N/A';
    return new Date(timestamp).toLocaleString('ru-RU');
}
</script>
{% endblock %}
